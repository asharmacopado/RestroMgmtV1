<!-- /**
 * @author Akshay Jarandikar and Milind Gokhale
 * Creation Date: July 7, 2015
 * This class is the front end visualforce page created for parallel development of MenuCart functionality,
 * This code is to be periodically integrated with the frontend visualforce menu page. 
 */
 -->

<apex:page showheader="false" controller="Cart"  standardstylesheets="false">
    <style type="text/css">
        <!-- /* Some custom styles to beautify this example */-->
        .col-sm-6{
        margin-top:10px;
        padding:0px;
        border: black 1px solid
        background-color:white;
        -webkit-border-radius: 5px !important;
        -moz-border-radius: 5px !important;
        border-radius: 5px !important;
        }
        
        .col-md-6{
        border: black 1px solid
        -webkit-border-radius: 5px !important;
        -moz-border-radius: 5px !important;
        border-radius: 5px !important;       }
        
        .col-lg-4{
        border: black 1px solid
        -webkit-border-radius: 5px !important;
        -moz-border-radius: 5px !important;
        border-radius: 5px !important;
        }
        
        .panel-body {
        border: black 1px solid
        background-image:none !important;
        background-color:white !important;
        padding:0px;
        }
        
        .cardimage{
        
        background-size:100%;
        float:left;
        }
        
        .desc{
        
        background-size:100%;
        
        
        margin:0px;
        float:left;
        text-shadow:none;
        
        }
        .panel-default >.panel-heading {
        background-image:none;
        
        }
        .panel-default >.panel-heading > .panel-title {
        color:white;
        }
        
        #menu_btn, #view_cart_btn{
        background-image:none;
        background-color:maroon;
        text-shadow:none;
        width: 100%;
        height: 50px;
        }
        
        #open_cart{
        background-color:maroon;
        color:white;
        text-shadow:none;
        }
        
        
        #menu_link, #view_cart_link{
        text-align:left;
        background-image:none;
        color: black;
        font-size: 18px;
        text-shadow:none;
        color:white;
        width:100%;
        height:50px;
        padding:5px;
        margin:0px;
        
        }
        


/**Styling for the new cart UI: Starts **/
    .apexp{
        /*width: 200px;*/
    }
    .list-group{
        /*width: 200px;*/
        margin-bottom:0px;
    }
    .bs-example{
        margin-bottom: 10px;
    }
    .bPageBlock .pbTitle{
        width:100%;
    }
    .bPageBlock{
        width:100%;
        border:0px;
    }
    .apexp .bPageBlock.apexDefaultPageBlock .pbBody{
        margin:0px;
    }
    .h2, h2{
        font-size:18px;
    }
    .item-actions{
        border-radius:50%;margin-left:10px;margin-right:10px;
    }


    .center{
		width: 120px;
		margin: 0px auto;
  
	}
/**Styling for the new cart UI: End **/

    </style>
    <head>
        
        <apex:includeScript value="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js" />
        <apex:includeScript value="https://code.jquery.com/ui/1.10.0/jquery-ui.js" />
        <apex:includeScript value="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js" />
        <apex:includeScript value="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js" />
        <apex:includeScript value="{!$Resource.json2}"/>
        <apex:includeScript value="/soap/ajax/29.0/connection.js"/>
        <apex:includeScript value="/soap/ajax/29.0/apex.js"/>
        
        <apex:stylesheet value="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css"  />
        <apex:stylesheet value="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css"  />
        <apex:stylesheet value="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css"  />
        <apex:stylesheet value="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css"  />
        
<!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script> -->

<script type="text/javascript">
    sforce.connection.sessionId = "{!$Api.Session_ID}";
    $j = jQuery.noConflict();
    

    
    function sayHello(){
        }

var jsonObj=null;

//function updateChanges(jsonObj);

</script>        
        
    </head>
    <body>



        <apex:pageBlock >


            <div class="container">
            
<a id="modal-615533" href="#modal-container-615533" role="button" class="btn" data-toggle="modal">Launch demo modal</a>

<div class="modal fade" id="modal-container-615533" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
                <div class="modal-dialog">
                    <div class="modal-content">
                    <apex:form >
                        <div class="modal-header">
                             
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                                Ã—
                            </button>
                            <h4 class="modal-title" id="myModalLabel">
                                Modal title
                            </h4>
                        </div>
                        <div class="modal-body">
                <apex:pageBlock id="billed_items_modal" title="Billed Items">
                        <apex:repeat value="{!orderItemsList}" var="pitem" id="repeat">
                            <div class="container-fluid">
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="list-group">
                                            <div class="list-group-item">
                                                <a href="#" class="list-group-item active">
                                                    <span class="glyphicon">{!pitem.quantity}</span> 
                                                        {!pitem.name} 
                                                    <span class="badge">{!pitem.totalPrice}</span>
                                                </a>
                                                <apex:outputLabel rendered="{! if(pitem.status=='Pending',true,false)}">
                                                <div class="row">
                				                    <div class="col-xs-8 col-sm-8 col-md-8 col-lg-8">
                				                        <div class="input-group">
                                                              <span class="input-group-btn">
                                                                  <button type="button" class="btn btn-default btn-number" data-type="minus" data-field="quant[{! pitem.id}]">
                                                                      <span class="glyphicon glyphicon-minus"></span>
                                                                  </button>
                                                              </span>
                                                              <input type="text" name="quant[{! pitem.id}]" class="form-control input-number" value="{! pitem.quantity}" min="1" max="10" />
                                                              <span class="input-group-btn">
                                                                  <button type="button" class="btn btn-default btn-number" data-type="plus" data-field="quant[{! pitem.id}]">
                                                                      <span class="glyphicon glyphicon-plus"></span>
                                                                  </button>
                                                              </span>
                                                          </div>
                				                        </div>
                				                    <div class="col-xs-4 col-sm-4 col-md-4 col-lg-4">
                				                        <div style="text-align: right;">
                                                          <button type="button" style="width:inherit;" class="btn btn-primary" aria-label="Delete">
                                                            <span class="glyphicon glyphicon-trash" style="width:auto !important" aria-hidden="true"></span>
                                                          </button>
                                                        </div>
                				                    </div>
                			                    </div>
                			                    </apex:outputLabel>
                                            </div>
                                        </div>
                                        <!--<apex:outputPanel style="horizontal-align:center;" rendered="{!if(pitem.status == 'Pending', true, false)}"> -->
                                            <!-- <div class="list-group" > -->
                                                <!--    <apex:commandButton styleClass="btn btn-primary item-actions" value="+" action="{!onAdd}" rendered="{!pitem.status == 'Pending'}" disabled="{!if(OR(pitem.quantity > 4, pitem.status != 'Pending'), true, false)}" rerender="billed_items, cart_table, current_bill, estimated_bill">
                                                         <apex:param name="Id" value="{!pitem.id}"/>                                  
                                                   </apex:commandButton>   
                                                   <apex:commandButton styleClass="btn btn-primary item-actions" value="-" action="{!onRemove}" rendered="{!pitem.status == 'Pending'}"  disabled="{!if(OR(pitem.quantity < 2, pitem.status != 'Pending'), true, false)}" rerender="billed_items, cart_table, current_bill, estimated_bill">
                                                         <apex:param name="Id" value="{!pitem.id}"/>                                  
                                                   </apex:commandButton> 
                                                   <apex:commandButton styleClass="btn btn-primary item-actions" value="X" action="{!onDelete}" rendered="{!pitem.status == 'Pending'}" disabled="{!pitem.status != 'Pending'}" rerender="billed_items, cart_table, current_bill, estimated_bill">
                                                         <apex:param name="Id" value="{!pitem.id}"/>                                  
                                                   </apex:commandButton> -->
                                            <!-- </div> -->
        
                                        <!-- </apex:outputPanel> -->
                                    </div>
                                </div>
                            </div>
                        </apex:repeat>
                </apex:pageBlock>

                
                            
                            
                            
                        </div>
                        <div class="modal-footer">
                             
                            <button type="button" class="btn btn-default" data-dismiss="modal">
                                Close
                            </button> 

                            <button type="button" class="btn btn-primary btn-save">
                                Save changes
                            </button>
                        </div>
                    </apex:form>
                    </div>
                    
                </div>
                
            </div>

                        <!-- Placeholder for div - bill_items pageblock -->
                <apex:pageBlock id="billed_items" title="Billed Items">
                    <apex:form >
                        <a id="modal-615533" href="#modal-container-615533" role="button" class="btn" data-toggle="modal">
                            <button type="button" class="btn btn-primary" aria-label="Edit Items">
                                <span class="glyphicon glyphicon-edit" aria-hidden="true"></span>
                            Edit Items
                            </button>
                        </a>
                        <apex:repeat value="{!orderItemsList}" var="pitem" id="repeat">
                            <div class="bs-example">
                                <div class="list-group">
                                    <a href="#" class="list-group-item active">
                                        <span class="glyphicon">{!pitem.quantity}</span> 
                                            {!pitem.name} 
                                        <span class="badge">{!pitem.totalPrice}</span>
                                    </a>
                                </div>
                                <!-- <apex:outputPanel style="horizontal-align:center;" rendered="{!if(pitem.status == 'Pending', true, false)}"> -->
                                    <!-- <div class="list-group" > -->
                                        <!--<div class="list-group-item" style="margin:0px;padding:0px;">-->
                                           <!-- <apex:commandButton styleClass="btn btn-primary item-actions" value="+" action="{!onAdd}" rendered="{!pitem.status == 'Pending'}" disabled="{!if(OR(pitem.quantity > 4, pitem.status != 'Pending'), true, false)}" rerender="billed_items, cart_table, current_bill, estimated_bill">
                                                 <apex:param name="Id" value="{!pitem.id}"/>                                  
                                           </apex:commandButton>   
                                           <apex:commandButton styleClass="btn btn-primary item-actions" value="-" action="{!onRemove}" rendered="{!pitem.status == 'Pending'}"  disabled="{!if(OR(pitem.quantity < 2, pitem.status != 'Pending'), true, false)}" rerender="billed_items, cart_table, current_bill, estimated_bill">
                                                 <apex:param name="Id" value="{!pitem.id}"/>                                  
                                           </apex:commandButton> 
                                           <apex:commandButton styleClass="btn btn-primary item-actions" value="X" action="{!onDelete}" rendered="{!pitem.status == 'Pending'}" disabled="{!pitem.status != 'Pending'}" rerender="billed_items, cart_table, current_bill, estimated_bill">
                                                 <apex:param name="Id" value="{!pitem.id}"/>                                  
                                           </apex:commandButton> -->
                                        <!--</div>-->
                                   <!-- </div>
                                </apex:outputPanel> -->
                            </div>
                        </apex:repeat>
                    </apex:form>
                </apex:pageBlock>

                    
                    <!-- Placeholder for div - current_bill pageblock -->
                <apex:pageBlock id="current_bill">
                    <div class="bs-example">
                        <div class="list-group">
                            <a href="#" class="list-group-item active">
                                <span class="glyphicon">Taxes</span> 
                                <span class="badge">{!FoodOrder.Tax__c}</span>
                            </a>
                            <a href="#" class="list-group-item active">
                                <span class="glyphicon">Current Bill</span> 
                                <span class="badge">{!FoodOrder.TotalPrice__c}</span>
                            </a>
                        </div>
                    </div>
                </apex:pageBlock>


                        <!-- Placeholder for div - cart_table pageblock -->
                <apex:pageBlock id="cart_table" title="Cart">
                    <apex:form >
                    <apex:actionFunction name="sayHello" action="{!sayHello}" reRender="billed_items, cart_table, current_bill, estimated_bill, cart_action_buttons,  billed_items_modal"/>
                                    
                        <apex:repeat value="{!activeCartItems}" var="pitem" id="repeat">
                            <div class="bs-example">
                                <div class="list-group">
                                    <a href="#" class="list-group-item active">
                                        <span class="glyphicon">{!pitem.quantity}</span> 
                                            {!pitem.name} 
                                        <span class="badge">{!pitem.totalPrice}</span>
                                    </a>
                                </div>
                                <apex:outputPanel style="horizontal-align:center;" >
                                    <div class="list-group" >
                                        <div class="list-group-item" style="margin:0px;padding:0px;">
                                            <apex:commandButton styleClass="btn btn-primary item-actions" value="+" action="{!onAdd}" disabled="{!pitem.quantity > 4}" rerender="billed_items, cart_table, current_bill, estimated_bill">
                                                 <apex:param name="Id" value="{!pitem.id}"/>                                  
                                           </apex:commandButton>   
                                           <apex:commandButton styleClass="btn btn-primary item-actions" value="-" action="{!onRemove}" disabled="{!pitem.quantity < 2}" rerender="billed_items, cart_table, current_bill, estimated_bill">
                                                 <apex:param name="Id" value="{!pitem.id}"/>                                  
                                           </apex:commandButton> 
                                           <apex:commandButton styleClass="btn btn-primary item-actions" value="X" action="{!onDelete}" rerender="billed_items, cart_table, current_bill, estimated_bill">
                                                 <apex:param name="Id" value="{!pitem.id}"/>                                  
                                           </apex:commandButton>
                                        </div>
                                    </div>
                                </apex:outputPanel>
                            </div>
                        </apex:repeat>
                        <apex:commandButton styleClass="btn btn-primary" value="Place Order" action="{!placeOrder}" rerender="billed_items, cart_table, current_bill, estimated_bill">
                            <apex:param name="Id" value="{!FoodOrder.id}"/>                                  
                        </apex:commandButton>                                        
                        <apex:commandButton styleClass="btn btn-primary" value="Reset Cart" rendered="{!FoodOrder.Status__c=='New'}" action="{!resetCart}" rerender="billed_items, cart_table, current_bill, estimated_bill">
                            <apex:param name="Id" value="{!FoodOrder.id}"/>                                  
                        </apex:commandButton>
                    </apex:form>
                </apex:pageBlock>
                
                <br/>
                    <!-- Placeholder for div - estimated_bill pageblock -->
                <apex:pageBlock id="estimated_bill">
                    <div class="bs-example">
                        <div class="list-group">
                            <a href="#" class="list-group-item active">
                                <span class="glyphicon">Taxes</span> 
                                <span class="badge">{!FoodOrder.TaxEstimate__c}</span>
                            </a>
                            <a href="#" class="list-group-item active">
                                <span class="glyphicon">Estimated Bill</span> 
                                <span class="badge">{!FoodOrder.TotalPriceEstimate__c}</span>
                            </a>
                        </div>
                    </div>
                </apex:pageBlock>
                
                <apex:form >
                <apex:commandLink styleClass="btn" action="{! payBill}" value="Pay Now" rendered="{!FoodOrder.Status__c=='Delivered' }"  />                                            
                </apex:form>

            </div>                        
              
        </apex:pageBlock>
        

<!-- src="{!$Resource.PlusMinusJs}" -->

<script type="text/javascript" > 
    //plugin bootstrap minus and plus
//http://jsfiddle.net/laelitenetwork/puJ6G/
jQuery('.btn-number').click(function(e){
    e.preventDefault();
    
    fieldName = jQuery(this).attr('data-field');
    type      = jQuery(this).attr('data-type');
    var input = jQuery("input[name='"+fieldName+"']");
    var currentVal = parseInt(input.val());
    if (!isNaN(currentVal)) {
        if(type == 'minus') {
            
            if(currentVal > input.attr('min')) {
                input.val(currentVal - 1).change();
            } 
            if(parseInt(input.val()) == input.attr('min')) {
                jQuery(this).attr('disabled', true);
            }

        } else if(type == 'plus') {

            if(currentVal < input.attr('max')) {
                input.val(currentVal + 1).change();
            }
            if(parseInt(input.val()) == input.attr('max')) {
                jQuery(this).attr('disabled', true);
            }

        }
    } else {
        input.val(0);
    }
});
jQuery('.input-number').focusin(function(){
   jQuery(this).data('oldValue', jQuery(this).val());
});
jQuery('.input-number').change(function() {
    console.log(this);
    fieldName = jQuery(this).attr('name');
    fieldName = fieldName.substring(6,fieldName.length-1);
    minValue =  parseInt(jQuery(this).attr('min'));
    maxValue =  parseInt(jQuery(this).attr('max'));
    valueCurrent = parseInt(jQuery(this).val());
    
    name = jQuery(this).attr('name');
    if(valueCurrent >= minValue) {
        jQuery(".btn-number[data-type='minus'][data-field='"+name+"']").removeAttr('disabled')
    } else {
        alert('Sorry, the minimum value was reached');
        jQuery(this).val(jQuery(this).data('oldValue'));
    }
    if(valueCurrent <= maxValue) {
        jQuery(".btn-number[data-type='plus'][data-field='"+name+"']").removeAttr('disabled')
    } else {
        alert('Sorry, the maximum value was reached');
        jQuery(this).val(jQuery(this).data('oldValue'));
    }
    console.log(this);
    console.log(parseInt(jQuery(this).val()));
    createNewChangedObj(fieldName,parseInt(jQuery(this).val()));

});

function createNewChangedObj(id,newQuantity){
    var orderItemObj = new sforce.SObject("Order_Item__c");
        orderItemObj.Id = id;
        orderItemObj.Quantity__c = parseInt(newQuantity);
        console.log(orderItemObj);
        console.log(o);
        o.changedOrderItemsMap[id] = orderItemObj;
        console.log(o.changedOrderItemsMap);
}

jQuery(".input-number").keydown(function (e) {
        // Allow: backspace, delete, tab, escape, enter and .
        if (jQuery.inArray(e.keyCode, [46, 8, 9, 27, 13, 190]) !== -1 ||
             // Allow: Ctrl+A
            (e.keyCode == 65 && e.ctrlKey === true) || 
             // Allow: home, end, left, right
            (e.keyCode >= 35 && e.keyCode <= 39)) {
                 // let it happen, don't do anything
                 return;
        }
        // Ensure that it is a number and stop the keypress
        if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
            e.preventDefault();
        }
    });

var OrderedItems = function (){
    console.log('OrderedItems class instantiated');
    this.origOrderedItems;
    this.changedOrderItemsMap = {};
    this.changedOrderItems=new Array();
    this.convertToArray = function() {
        this.changedOrderItems = jQuery.map(this.changedOrderItemsMap, function(value, index) {
        return [value];
            //for(key in this.changedOrderItemsMap){
                //this.changedOrderItems.push(this.changedOrderItemsMap[key]);
            //}
        });
    }
}

var o = new OrderedItems();

jQuery('.btn-save').click(function(e){
    console.log('Changes saved');
    o.origOrderedItems = {! orderItemsListSerialized};
    console.log(OrderedItems.origOrderedItems);
    //jsonObj=JSON.stringify(serialOrderItemsList);
    //console.log(jsonObj);
    /*var newRecords = new Array();
    //for(i = 0; i<o.origOrderedItems.length; i++){
        ..var orderItemObj = new sforce.SObject("Order_Item__c");
        orderItemObj.Id = o.origOrderedItems[i].Id;
        //orderItemObj.Name = records[i].Name;
        orderItemObj.Quantity__c = i+1;
        console.log(orderItemObj);
        newRecords.push(orderItemObj);
    }*/
    o.convertToArray();
    console.log(o.changedOrderItems);
    //console.log(newRecords);
    var result = sforce.connection.update(o.changedOrderItems);
    console.log(result);
    if (!result[0].getBoolean('success')) 
    { 
        alert('An error occurred updating this record:\n\n' + result[0].errors.message); 
    }
    sayHello();
    /*Visualforce.remoting.Manager.invokeAction(
        //'{!$RemoteAction.Cart.updateChanges}',
        o.changedOrderItems,
        function(result, event) {
          console.log(result);
        }); */
});



</script>
    </body>
</apex:page>